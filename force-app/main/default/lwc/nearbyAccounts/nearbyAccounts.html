<template>
    <template if:true={showInitialNote}>
        <div class="slds-notify slds-notify_alert slds-theme_info slds-m-bottom_medium" role="alert">
            <span class="slds-assistive-text">Info</span>
            <span>
                Please select a location or enable "Use Current Location" to view nearby accounts.
            </span>
        </div>
    </template>
    <lightning-card title="Nearby Accounts" icon-name="standard:account">
        <!-- Error Message -->
        <!-- Removed error message banner -->

        <div class="slds-p-around_medium">
            <!-- 1-2 Column Filter Layout -->
            <div class="slds-grid slds-m-bottom_medium">
                <!-- Location Filters: 2/5 width -->
                <div class="slds-col slds-size_2-of-5">
                    <div class="slds-box slds-theme_default slds-m-right_medium modern-card fade-in">
                        <div class="slds-text-title_bold slds-m-bottom_small">
                            <lightning-icon icon-name="utility:location" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                            Location Filters
                        </div>
                        <div class="slds-m-bottom_small">
                            <div style="display: inline-block;">
                                <lightning-input 
                                    type="toggle" 
                                    label="Use Current Location" 
                                    checked={useCurrentLocation} 
                                    onchange={handleLocationToggle}
                                    field-level-help="Enable to use your browser's current location for searching nearby accounts.">
                                </lightning-input>
                            </div>
                        </div>
                        <template if:true={useCurrentLocation}>
                            <div class="slds-form-element slds-m-bottom_small">
                                <label class="slds-form-element__label">
                                    Location
                                    <lightning-helptext content="This is your current location as detected by your browser."></lightning-helptext>
                                </label>
                                <div class="slds-form-element__control">
                                    <span>{currentAddress}</span>
                                </div>
                            </div>
                            <template if:true={locationStatus}>
                                <!-- Removed location status message as per user request -->
                            </template>
                        </template>
                        <template if:false={useCurrentLocation}>
                            <div class="slds-form-element">
                                <lightning-input
                                class = "searchAddressClass"
                                    label="Search Address"
                                    type="search"
                                    value={address}
                                    onchange={handleSearchChange}
                                    onfocus={showPickListOptions}
                                    placeholder="Type to search address..."
                                    field-level-help="Type to search for an address"
                                >
                                </lightning-input>
                                <template if:true={suggestions.length}>
                                    <div
                                        class="slds-dropdown slds-dropdown_length-5 slds-dropdown_fluid"
                                        role="listbox"
                                    >
                                        <ul
                                            class="slds-listbox slds-listbox_vertical"
                                            role="presentation"
                                        >
                                            <template
                                                for:each={suggestions}
                                                for:item="suggestion"
                                            >
                                                <li
                                                    key={suggestion.place_id}
                                                    data-place-id={suggestion.place_id}
                                                    role="presentation"
                                                    onclick={handleSuggestionClick}
                                                    class="slds-listbox__item"
                                                >
                                                    <div
                                                        class="slds-media slds-listbox__option slds-listbox__option_plain slds-media_small"
                                                        role="option"
                                                    >
                                                        <span class="slds-media__body">
                                                            <span
                                                                class="slds-truncate"
                                                                title={suggestion.description}
                                                            >
                                                                {suggestion.description}
                                                            </span>
                                                        </span>
                                                    </div>
                                                </li>
                                            </template>
                                        </ul>
                                    </div>
                                </template>
                                <template if:true={suggestionError}>
                                    <div class="slds-dropdown slds-dropdown_length-5 slds-dropdown_fluid" role="listbox">
                                        <div class="slds-p-around_small slds-text-color_weak">{suggestionError}</div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <div class="slds-m-bottom_small">
                            <lightning-input type="number" label="Radius (miles)" value={radius} onchange={handleRadiusChange} 
                                placeholder="1"
                                field-level-help="Shows accounts within this radius from the selected location."></lightning-input>
                        </div>
                    </div>
                </div>
                <!-- Account Filters: 3/5 width, two fields per row -->
                <div class="slds-col slds-size_3-of-5">
                    <div class="slds-box slds-theme_default modern-card fade-in">
                        <div class="slds-text-title_bold slds-m-bottom_small">
                            <lightning-icon icon-name="standard:account" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                            Account Filters
                        </div>
                        <div class="slds-grid slds-gutters slds-m-bottom_small">
                            <div class="slds-col slds-size_1-of-2">
                                <c-multi-select-picklist
                                    label="Account Type"
                                    value={accountTypeFilter}
                                    options={accountTypeOptions}
                                    onvaluechange={handleAccountTypeFilterChange}
                                    onsearchtrigger={handleAccountTypeSearchTrigger}
                                    selectionlimit="10"
                                ></c-multi-select-picklist>
                            </div>
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-combobox label="Segment" value={segment} options={segmentOptions} onchange={handleSegmentChange}
                                    field-level-help="Filter accounts by segment. Select 'All' to include all segments."></lightning-combobox>
                            </div>
                        </div>
                        <div class="slds-grid slds-gutters slds-m-bottom_small">
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-combobox label="Industry" value={industry} options={industryOptions} onchange={handleIndustryChange}
                                    field-level-help="Filter accounts by industry. Select 'All' to include all industries."></lightning-combobox>
                            </div>
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-combobox label="CS Sentiment" value={csSentiment} options={csSentimentOptions} onchange={handleCsSentimentChange}
                                    field-level-help="Filter accounts by customer success sentiment. Select 'All' to include all sentiments."></lightning-combobox>
                            </div>
                        </div>
                        <div class="slds-grid slds-gutters slds-m-bottom_small">
                            <div class="slds-col slds-size_1-of-2">
                                <c-multi-select-picklist
                                    label="Owner"
                                    value={ownerFilter}
                                    options={ownerOptions}
                                    onvaluechange={handleOwnerFilterChange}
                                    onsearchtrigger={handleOwnerSearchTrigger}
                                    selectionlimit="10"
                                ></c-multi-select-picklist>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Map Section -->
            <div class="slds-box slds-theme_default slds-m-top_medium modern-card fade-in">
                <div class="slds-grid slds-grid_align-spread slds-m-bottom_small">
                    <div class="slds-text-heading_small">
                        <lightning-icon icon-name="utility:map" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                        Map View
                    </div>
                    <template if:true={isMobile}>
                        <lightning-button-icon
                            icon-name={landscapeToggleIcon}
                            variant="bare"
                            alternative-text={landscapeToggleAltText}
                            onclick={toggleLandscapeMode}
                            class="landscape-toggle-btn">
                        </lightning-button-icon>
                    </template>
                </div>
                <!-- Legend Above Map -->
                <div class="map-legend">
                    <div class="legend-item">
                        <div class="legend-circle customer-pipeline"></div>
                        <span class="legend-text">Customer with Pipeline</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-circle customer-no-pipeline"></div>
                        <span class="legend-text">Customer (No Pipeline)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-circle prospect-pipeline"></div>
                        <span class="legend-text">Prospect with Pipeline</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-circle prospect-no-pipeline"></div>
                        <span class="legend-text">Prospect (No Pipeline)</span>
                    </div>
                </div>
                
                <div class={mapContainerClass}>
                    
                    <template if:true={isMapLoading}>
                        <div class="slds-is-relative" style="z-index:10; position:absolute; top:0; left:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.7);">
                            <lightning-spinner alternative-text="Loading map" size="small" variant="brand"></lightning-spinner>
                        </div>
                    </template>
                    <lightning-map
                        map-markers={mapMarkers}
                        zoom-level={mapZoomLevel}
                        center={mapCenter}
                        markers-title="Accounts">
                    </lightning-map>
                </div>
            </div>
            <!-- List/Table Section -->
            <div class="slds-box slds-theme_default slds-m-top_medium modern-card fade-in">
                <div class="slds-text-heading_small slds-m-bottom_small">
                    <lightning-icon icon-name="utility:table" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                    Results ({totalRecords} records found)
                </div>
                <template if:true={isMobile}>
                    <template for:each={accounts} for:item="acc">
                        <div key={acc.Id} class="mobile-record-card">
                            <div class="mobile-record-header">{acc.Name}</div>
                            <div class="mobile-record-field">{acc.formattedAddress}</div>
                            <div class="mobile-record-field">Owner: {acc.OwnerName}</div>
                            <div class="mobile-record-field">ARR: {acc.Total_Parent_Account_Customer_ARR__c}</div>
                            <div class="mobile-record-field">Pipeline: {acc.Total_Pipeline__c}</div>
                            <div class="mobile-record-field">Distance: {acc.Distance}</div>
                            <div class="mobile-record-field">Segment: {acc.Segment__c}</div>
                            <div class="mobile-record-field">Industry: {acc.Industry}</div>
                            <div class="mobile-record-field">Sentiment: {acc.CSM_Health_Rating__c}</div>
                            <lightning-button
                                label="Navigate"
                                name="navigate"
                                data-account-id={acc.Id}
                                onclick={handleNavigate}
                                class="mobile-navigate-btn"
                            ></lightning-button>
                        </div>
                    </template>
                </template>
                <template if:false={isMobile}>
                    <div class="slds-table_header-fixed_container" style="position:relative;">
                        <template if:true={isTableLoading}>
                            <div class="slds-is-relative" style="z-index:10; position:absolute; top:0; left:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.7);">
                                <lightning-spinner alternative-text="Loading table" size="small" variant="brand"></lightning-spinner>
                            </div>
                        </template>
                        <div class="slds-scrollable_x" style="width: 100%;">
                            <lightning-datatable
                                key-field="Id"
                                data={accounts}
                                columns={columns}
                                hide-checkbox-column
                                sorted-by={sortedBy}
                                sorted-direction={sortedDirection}
                                onsort={handleSort}
                                onrowaction={handleRowAction}
                                class="slds-table_header-fixed"
                                style="width: 100%;">
                            </lightning-datatable>
                        </div>
                    </div>
                </template>
                <!-- Pagination Controls -->
                <div class="slds-grid slds-grid_align-spread slds-m-top_medium">
                    <div class="slds-col">
                        <lightning-button-group>
                            <lightning-button 
                                label="First" 
                                onclick={handleFirst}
                                disabled={isFirstPage}>
                            </lightning-button>
                            <lightning-button 
                                label="Previous" 
                                onclick={handlePrevious}
                                disabled={isFirstPage}>
                            </lightning-button>
                            <lightning-button 
                                label="Next" 
                                onclick={handleNext}
                                disabled={isLastPage}>
                            </lightning-button>
                            <lightning-button 
                                label="Last" 
                                onclick={handleLast}
                                disabled={isLastPage}>
                            </lightning-button>
                        </lightning-button-group>
                    </div>
                    <div class="slds-col slds-text-align_right slds-text-body_regular">
                        Showing {startRecord} to {endRecord} of {totalRecords} records
                    </div>
                </div>
            </div>
        </div>
    </lightning-card>
    <template if:true={showNavModal}>
        <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container">
                <header class="slds-modal__header">
                    <h2 class="slds-modal__title">Navigate to {selectedAccountName}</h2>
                </header>
                <div class="slds-modal__content slds-p-around_medium">
                    <div class="slds-p-around_medium slds-text-align_center">
                        <div class="slds-m-bottom_small">
                            <lightning-button label="Google Maps" icon-name="utility:location" variant="brand-outline" onclick={handleGoogleMaps} style="width: 200px;"></lightning-button>
                        </div>
                        <div>
                            <lightning-button label="Apple Maps" icon-name="utility:location" variant="neutral" onclick={handleAppleMaps} style="width: 200px;"></lightning-button>
                        </div>
                    </div>
                </div>
                <footer class="slds-modal__footer">
                    <lightning-button label="Close" onclick={closeNavModal}></lightning-button>
                </footer>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
</template>